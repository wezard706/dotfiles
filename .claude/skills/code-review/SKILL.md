---
name: code-review
description: セキュリティ、パフォーマンス、アーキテクチャを含む包括的なコード品質レビュー。mainブランチからのローカル差分を対象に、コード品質、セキュリティ、パフォーマンス、テスト、ドキュメンテーション、OOD設計の6つのフォーカスエリアで評価を行う。「コードレビューして」「レビューお願い」「差分をチェックして」などのリクエスト時にトリガーする。
---

# コードレビュー

以下のフォーカスエリアに基づき、包括的なコードレビューを実施する。

## ワークフロー

### 1. 差分の取得と概要把握

```bash
git diff main...HEAD
git log main..HEAD --oneline
```

変更がない場合はその旨を伝えて終了する。

### 2. CLAUDE.mdの収集

プロジェクトルートおよび変更されたファイルのディレクトリにある CLAUDE.md をすべて読み込む。

### 3. 並列レビュー

以下の6つのフォーカスエリアで並列にレビューを実行する。各観点はTaskツールでSonnetエージェントに委譲する。

#### 1. コード品質

クリーンコードの原則とベストプラクティス

- 適切なエラーハンドリングとエッジケースの考慮
- コードの可読性と保守性

#### 2. セキュリティ

- 潜在的なセキュリティ脆弱性の確認
- 入力値のサニタイズ（無害化）の検証
- 認証・認可ロジックの確認

#### 3. パフォーマンス

- パフォーマンスのボトルネックとなる箇所の特定
- データベースクエリの効率性の確認
- メモリリークやリソース管理の問題の確認

#### 4. テスト

- 十分なテストカバレッジの確認
- テストの質とエッジケースの検証
- 不足しているテストシナリオの特定

#### 5. ドキュメンテーション

- コードが適切にドキュメント化されているかの確認
- 新機能に対する README の更新確認
- API ドキュメントの正確性の確認

#### 6. オブジェクト指向設計 (OOD)

SOLID 原則（単一責任、オープン/クローズドなど）への準拠

- デザインパターンの適切な適用
- 適切なカプセル化、継承、ポリモーフィズムの利用
- クラス・モジュール間の高い凝集性と低い結合度の確認
- サービスクラスの厳格な評価:
  - 新しいサービスクラスが導入された場合、その必要性を厳格に評価する
  - ドメインモデルからロジックが奪われていないか（ドメインモデルの貧血化の防止）を確認
  - そのロジックが既存のエンティティやバリューオブジェクトに配置されるべきではないかを検討

### 4. 信頼度スコアリング

各指摘に0〜100の信頼度スコアを付与する。

- **0**: 誤検知。精査に耐えない、または既存の問題
- **25**: やや自信あり。実際の問題かもしれないが誤検知の可能性もある
- **50**: 中程度の自信。実際の問題だが、軽微またはニッチ
- **75**: 高い自信。検証済みで、実際に影響がある問題
- **100**: 確実。二重チェック済みで、頻繁に発生する問題

スコア75未満の指摘はフィルタリングする。

### 5. 誤検知の除外

以下は誤検知として除外する:

- 変更前から存在していた問題
- リンター・型チェッカー・コンパイラが検出する問題
- CLAUDE.mdで明示的に抑制されている問題（lint ignoreコメント等）
- 意図的な機能変更に対する指摘
- 変更していない行に対する指摘
- シニアエンジニアが指摘しないような些細なnitpick

### 6. 結果の出力

以下の形式でターミナルに出力する。

指摘がある場合:

```markdown
## コードレビュー結果

N件の指摘:

### 1. [フォーカスエリア] 指摘の要約

**ファイル**: `path/to/file.rb:42`
**信頼度**: 85/100
**詳細**: 具体的な問題の説明と改善案

### 2. ...
```

指摘がない場合:

```markdown
## コードレビュー結果

指摘なし。コード品質、セキュリティ、パフォーマンス、テスト、ドキュメンテーション、OODを確認済み。
```
