---
name: ddd-modeling
description: DDDの戦略的設計に従って概念モデリングを行う。ドメイン分析、サブドメインの分類（コア・支援・汎用）、境界づけられたコンテキストの識別、ユビキタス言語の定義、コンテキストマップの作成を支援する。戦術的設計（集約・エンティティ・値オブジェクトの実装）は扱わない。「概念モデリングして」「ドメイン設計して」「DDDで設計して」「境界づけられたコンテキストを特定して」「ユビキタス言語を定義して」「ドメインモデルを整理して」などのリクエスト時にトリガーする。
---

# DDD戦略的設計 概念モデリング

DDDの**戦略的設計**に従い、ドメインを分析・モデル化する。

> **スコープ外**: 戦術的設計（集約・エンティティ・値オブジェクト・ドメインサービスの実装）は対象外。このスキルはサブドメイン分類・境界づけられたコンテキストの識別・コンテキストマップの作成までを扱う。

## ワークフロー概要

1. **ドメイン理解** — ビジネス目的と主要な業務を把握する
2. **サブドメイン分類** — コア・支援・汎用に分類する
3. **境界づけられたコンテキスト識別** — 言語の境界を見つける
4. **ユビキタス言語定義** — 各コンテキスト内の用語を定義する
5. **コンテキストマップ作成** — コンテキスト間の関係をモデル化する
6. **成果物出力** — モデリング結果を構造化して出力する

---

## Step 1: ドメインを理解する

**コードベースが存在する場合:**

```bash
# ディレクトリ構造を把握する
find . -type f -name "*.rb" | grep -v spec | head -50

# モデルクラスを確認する
find . -path "*/models/*.rb" | xargs grep -l "class " 2>/dev/null
```

- モデル名、メソッド名、変数名から業務用語を収集する
- コメントやREADMEからビジネス目的を把握する

**ユーザーヒアリングの場合:**

以下の質問でドメインを理解する:
- 「このシステムは誰のために何をするシステムですか？」
- 「最も重要な業務（コアドメイン）は何ですか？」
- 「どんな業務用語を日常的に使いますか？」

---

## Step 2: サブドメインを分類する

3種類に分類する。詳細は `references/ddd-patterns.md` の「サブドメイン」節を参照。

| 種類 | 説明 | 例 |
|------|------|-----|
| **コアドメイン** | 競合優位性の源泉。最も重要 | ECの推薦エンジン、物流最適化 |
| **支援サブドメイン** | コアを支えるが差別化にならない | 注文管理、在庫管理 |
| **汎用サブドメイン** | 既製品で代替可能 | 認証、通知、決済 |

**出力形式:**

```
## サブドメイン分類

### コアドメイン
- [名前]: [業務の説明と競合優位性の理由]

### 支援サブドメイン
- [名前]: [業務の説明]

### 汎用サブドメイン
- [名前]: [既製品候補]
```

---

## Step 3: 境界づけられたコンテキストを識別する

同じ言葉が異なる意味で使われる「言語の境界」を見つける。

**識別のヒント:**
- 同じ概念（例: 「顧客」「商品」）が文脈によって異なる属性を持つ場合 → 境界あり
- チームや組織の境界と一致することが多い
- データモデルが文脈によって変わる場合 → 境界あり

**各コンテキストに命名する際のルール:**
- 業務の言葉をそのまま使う（技術用語を避ける）
- 動詞句より名詞句を好む（「注文管理」「顧客サービス」など）

---

## Step 4: ユビキタス言語を定義する

各コンテキスト内で使われる用語を定義する。コンテキストをまたいで同じ用語が異なる意味を持つ場合は必ず明記する。

```
## ユビキタス言語: [コンテキスト名]

| 用語 | 定義 | 注意（他コンテキストとの差異） |
|------|------|-------------------------------|
| 顧客 | 注文を行う登録ユーザー | ※配送コンテキストでは「受取人」と呼ぶ |
| 注文 | 購入意思を示す確定済みリクエスト | ※在庫コンテキストでは「引当依頼」 |
```

---

## Step 5: コンテキストマップを作成する

コンテキスト間の関係パターンを特定する。

**主な関係パターン** (詳細は `references/context-map-patterns.md` を参照):

| パターン | 上流→下流 | 使用場面 |
|----------|----------|---------|
| Conformist (CF) | 上流の都合に従う | 外部API、レガシーシステム |
| Anti-Corruption Layer (ACL) | 変換層を挟む | 他モデルから守りたい場合 |
| Open Host Service (OHS) | 公開APIを提供 | 多数の下流がいる場合 |
| Shared Kernel (SK) | 共有モデル | 密結合チーム間 |
| Customer/Supplier | 下流が要件を持つ | 協調関係 |
| Partnership | 対等な協調 | 同一チーム内 |

**テキストによるコンテキストマップ表現:**

```
## コンテキストマップ

[注文コンテキスト] --[Customer/Supplier]--> [在庫コンテキスト]
[注文コンテキスト] --[OHS/PL]--> [配送コンテキスト]
[注文コンテキスト] --[CF + ACL]--> [決済コンテキスト（外部）]
```

---

## Step 6: 成果物を出力する

以下の構造で出力する:

```markdown
# ドメインモデリング: [システム名]

## 1. ドメイン概要
[ビジネス目的の要約。1〜3文]

## 2. サブドメイン分類
[Step 2の出力]

## 3. 境界づけられたコンテキスト
[各コンテキストの説明と責務]

## 4. ユビキタス言語
[Step 4の出力。コンテキストごとに分けて記述]

## 5. コンテキストマップ
[Step 5の出力]

## 6. モデリング上の主な決断と理由
[重要な設計判断とトレードオフを箇条書き]
```

---

## 参考リファレンス

- **サブドメイン詳細**: `references/ddd-patterns.md` — コア・支援・汎用の判断基準と投資配分の目安
- **コンテキストマップパターン**: `references/context-map-patterns.md` — 各パターンの詳細な適用基準と例
