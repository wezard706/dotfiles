# コンテキストマップ パターン詳細

## 目次
1. パターン一覧と選択ガイド
2. 各パターンの詳細
3. コンテキストマップの表記法

---

## 1. パターン一覧と選択ガイド

```
Q1: コンテキスト間の力関係は？
  → 一方が上流（提供者）、他方が下流（利用者）の関係か？

  上流・下流の非対称な関係 → Q2へ
  対等な協調関係 → Partnership または Shared Kernel

Q2: 下流は上流のモデルをそのまま使うか？
  → YES（従う）        → Conformist (CF)
  → NO（変換が必要）   → Q3へ

Q3: 誰が変換を担当するか？
  → 下流が自分でACLを用意  → Anti-Corruption Layer (ACL)
  → 上流が公開APIを提供    → Open Host Service (OHS) / Published Language (PL)

Q4: 関係を持たない方が良いか？
  → YES → Separate Ways
```

---

## 2. 各パターンの詳細

### Conformist (CF) — 順応者

**概要**: 下流が上流のモデルをそのまま受け入れる

**適用場面**:
- 上流が外部ベンダーやSaaSで変更できない
- 上流のモデルが十分に良質で翻訳コストが割に合わない
- 下流チームが上流に影響力を持てない

**例**:
```
[決済サービス(Stripe)] --[CF]--> [注文コンテキスト]
# 注文コンテキストはStripeのモデル（Charge, PaymentIntentなど）をそのまま使う
```

**表記**: `U → D [CF]`

---

### Anti-Corruption Layer (ACL) — 腐敗防止層

**概要**: 下流が翻訳レイヤーを設けて、上流のモデルが自コンテキストに侵食しないようにする

**適用場面**:
- 上流のモデルが下流のモデルと大きく異なる
- レガシーシステムやサードパーティとの統合
- 上流モデルの変化から自コンテキストを守りたい

**実装パターン**:
```ruby
# ACLの実装例: 外部の配送サービスのモデルを自コンテキストに変換
class DeliveryServiceAdapter
  def initialize(external_delivery_service)
    @external = external_delivery_service
  end

  # 外部の「Shipment」を自コンテキストの「Delivery」に変換
  def create_delivery(order)
    shipment = @external.create_shipment(
      recipient_name: order.customer.full_name,
      destination: order.shipping_address.to_h,
      package_weight: order.total_weight_kg
    )

    Delivery.new(
      tracking_number: shipment.tracking_id,
      estimated_arrival: shipment.eta,
      order_id: order.id
    )
  end
end
```

**表記**: `U → D [ACL]`

---

### Open Host Service (OHS) / Published Language (PL)

**概要**:
- **OHS**: 上流が複数の下流のために公開APIを提供する
- **PL**: OHSで使用するデータフォーマット（JSON Schema、Avroなど）を定義する

**適用場面**:
- 多数の下流コンテキストが1つの上流を利用する
- 統合ポイントを標準化・安定化させたい

**例**:
```
[商品カタログコンテキスト(OHS/PL)] --→ [注文コンテキスト]
                                  --→ [検索コンテキスト]
                                  --→ [推薦コンテキスト]
```

**表記**: `U [OHS/PL] → D`

---

### Shared Kernel (SK) — 共有カーネル

**概要**: 2つのコンテキストが一部のモデルを共有する

**適用場面**:
- 非常に密接に連携する2チームが共同でモデルを管理できる
- 共有モデルの変更が双方に影響するリスクを両チームが理解している

**注意**: Shared Kernelは強い結合を生む。使用は最小限に留める。

**表記**: `[SK]` 双方向矢印

---

### Customer/Supplier (顧客/供給者)

**概要**: 下流（顧客）が上流（供給者）に要件を持ち込み、上流がそれに応える

**適用場面**:
- 下流チームが上流チームに影響力を持てる
- スプリント計画・バックログを通じて調整できる

**表記**: `U [Customer/Supplier] → D`

---

### Partnership — パートナーシップ

**概要**: 2つのコンテキストが対等な立場で協力し、互いの成功に依存する

**適用場面**:
- 同じチームまたは密接に協力する2チームが管理
- 両コンテキストの機能が相互依存している

**リスク**: 結合が強いため、一方の変更が他方に即影響する

**表記**: `[Partnership]` 双方向矢印

---

### Separate Ways — 各自の道

**概要**: 2つのコンテキストが統合せず、それぞれ独自に実装する

**適用場面**:
- 統合コストが統合効果を上回る
- 要件が大きく異なり共有が困難

---

## 3. コンテキストマップの表記法

### テキスト表記（推奨）

```
# 矢印の方向: 上流 → 下流

[注文コンテキスト] --[Customer/Supplier]--> [在庫コンテキスト]
[注文コンテキスト] --[OHS/PL]--> [配送コンテキスト]
[注文コンテキスト] --[CF + ACL]--> [決済コンテキスト（Stripe）]
[商品コンテキスト(OHS/PL)] --→ [注文コンテキスト]
[商品コンテキスト(OHS/PL)] --→ [検索コンテキスト]
[認証コンテキスト(OHS)] --→ [注文コンテキスト]
[認証コンテキスト(OHS)] --→ [商品コンテキスト]
```

### 各コンテキストの説明テンプレート

```markdown
### [コンテキスト名] コンテキスト

**責務**: [このコンテキストが管理するビジネス上の責任]
**主要モデル**: [集約ルート, 重要なエンティティ・値オブジェクト]
**上流**: [依存している上流コンテキストと関係パターン]
**下流**: [このコンテキストに依存している下流コンテキスト]
**チーム/担当**: [オプション]
```

### コンテキストマップ作成の注意点

1. **すべての関係を洗い出す前に描き始めない** — まず全コンテキストを列挙し、その後関係を引く
2. **方向性を明確に** — データ・制御がどちらからどちらへ流れるか矢印で示す
3. **パターンを混合できる** — `[CF + ACL]` のように複数パターンの組み合わせが現実的
4. **汎用サブドメインは外部に置く** — Stripe、Auth0などは外部として境界の外に示す
